From e01898442c1867d9fd0bdb4f757f26690e95e859 Mon Sep 17 00:00:00 2001
From: Daniel Niasoff <4070285+dniasoff@users.noreply.github.com>
Date: Tue, 24 Oct 2023 13:41:10 +0000
Subject: [PATCH] some minor fixes

---
 .../configure_docker_storage_driver_fedora_coreos.sh          | 3 ++-
 .../templates/kubernetes/fragments/enable-auto-scaling.sh     | 4 ++--
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/magnum/drivers/common/templates/fragments/configure_docker_storage_driver_fedora_coreos.sh b/magnum/drivers/common/templates/fragments/configure_docker_storage_driver_fedora_coreos.sh
index e8b7a352..f0c4dcf4 100644
--- a/magnum/drivers/common/templates/fragments/configure_docker_storage_driver_fedora_coreos.sh
+++ b/magnum/drivers/common/templates/fragments/configure_docker_storage_driver_fedora_coreos.sh
@@ -11,9 +11,11 @@ fi
 clear_docker_storage () {
     # stop docker
     $ssh_cmd systemctl stop ${runtime}
+    $ssh_cmd systemctl stop var-lib-containerd.mount ${runtime}
     # clear storage graph
     $ssh_cmd rm -rf ${storage_dir}
     $ssh_cmd mkdir -p ${storage_dir}
+    $ssh_cmd systemctl start var-lib-containerd.mount ${runtime}
 }
 
 # Configure generic docker storage driver.
@@ -37,4 +39,3 @@ configure_storage_driver_generic() {
 configure_devicemapper() {
     configure_storage_driver_generic
 }
-
diff --git a/magnum/drivers/common/templates/kubernetes/fragments/enable-auto-scaling.sh b/magnum/drivers/common/templates/kubernetes/fragments/enable-auto-scaling.sh
index 3ebca746..ff0d4a39 100644
--- a/magnum/drivers/common/templates/kubernetes/fragments/enable-auto-scaling.sh
+++ b/magnum/drivers/common/templates/kubernetes/fragments/enable-auto-scaling.sh
@@ -50,7 +50,7 @@ rules:
     verbs: ["create"]
   # read-only access to cluster state
   - apiGroups: [""]
-    resources: ["services", "replicationcontrollers", "persistentvolumes", "persistentvolumeclaims"]
+    resources: ["services", "replicationcontrollers", "persistentvolumes", "persistentvolumeclaims","namespaces"]
     verbs: ["get", "list", "watch"]
   - apiGroups: ["apps"]
     resources: ["daemonsets", "replicasets"]
@@ -65,7 +65,7 @@ rules:
     resources: ["poddisruptionbudgets"]
     verbs: ["get", "list", "watch"]
   - apiGroups: ["storage.k8s.io"]
-    resources: ["storageclasses", "csinodes"]
+    resources: ["storageclasses", "csinodes","csistoragecapacities","csidrivers"]
     verbs: ["get", "list", "watch"]
   # misc access
   - apiGroups: [""]
-- 
2.34.1

